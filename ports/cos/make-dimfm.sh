#!/bin/bash
#
# Process PLDIMFM source in dimfm-library to create kftc
# compatible code, then cross-compile that code and build a static
# library, dimfilm.lib
#
function get_file() {
    echo "... getting $1"
    asciify -c cosdefs.json ../../dimfm-library/$1 dimfm-source/$1
    return 0
}

function compile() {
    echo "... compiling $1 ..."
    FNOF="${1%.f}"
    kftc -l ${FNOF}.lst -o ${FNOF}.cal -s -a static ${FNOF}.f
    cal -x -o ${FNOF}.o -l - -i ${FNOF}.cal >> ${FNOF}.lst
    return 0
}

echo "Build DIMFM library."
#
if [ -z "${OPT}" ]; then
    OPT=0
fi
if [ ! -d lib ]; then
    mkdir lib
fi
rm -rf dimfm-source
mkdir dimfm-source
#
F_LIST=(
abet.f
altpen.f
alttyp.f
autd.f
autor.f
autord.f
autort.f
autot.f
autox.f
autoxy.f
autoy.f
axcut.f
axtik.f
blank.f
blkdata.f
bounds.f
box.f
brksym.f
celar.f
celar1.f
celmap.f
celsc.f
celscr.f
cetar.f
cetsc.f
cetscr.f
cfmt.f
check.f
chhalf.f
cinter.f
cirarc.f
circle.f
clabel.f
clabht.f
cmodel.f
cmy.f
cmy1.f
cmy2.f
cmy3.f
color.f
color1.f
color2.f
color3.f
colpt1.f
colpt2.f
colpt3.f
colset.f
contr.f
contr1.f
contr2.f
contr3.f
cquad.f
cscale.f
cvhalf.f
cwhole.f
dash.f
deftyp.f
deggrp.f
degree.f
depbin.f
depcol.f
dfx000.f
dfx001.f
dfx002.f
dfx003.f
dfx004.f
dfx005.f
dfx006.f
dfx007.f
dfx008.f
dfx009.f
dfx010.f
dfx011.f
dfx01f.f
dfx020.f
dfx02f.f
dfx03f.f
dfx04f.f
dfx0aa.f
dfx100.f
dfx101.f
dfx104.f
dfx106.f
dfx107.f
dfx108.f
dfx109.f
dfx111.f
dfx112.f
dfx113.f
dfx120.f
dfx121.f
dfx122.f
dfx123.f
dfx124.f
dfx125.f
dfx126.f
dfx127.f
dfx128.f
dfx129.f
dfx130.f
dfx132.f
dfx133.f
dfx134.f
dfx135.f
dfx136.f
dfx137.f
dfx138.f
dfx141.f
dfx142.f
dfx143.f
dfx144.f
dfx145.f
dfx146.f
dfx147.f
dfx148.f
dfx149.f
dfx150.f
dfx151.f
dfx160.f
dfx161.f
dfx162.f
dfx163.f
dfx164.f
dfx165.f
dfx166.f
dfx170.f
dfx171.f
dfx172.f
dfx200.f
dfx201.f
dfx202.f
dfx204.f
dfx205.f
dfx206.f
dfx207.f
dfx208.f
dfx209.f
dfx210.f
dfx211.f
dfx212.f
dfx213.f
dfx214.f
dfx215.f
dfx216.f
dfx300.f
dfx302.f
dfx303.f
dfx304.f
dfx305.f
dfx306.f
dfx307.f
dfx308.f
dfx309.f
dfx310.f
dfx311.f
dfx312.f
dfx313.f
dfx314.f
dfx316.f
dfx317.f
dfx318.f
dfx319.f
dfx320.f
dfx321.f
dfx322.f
dfx324.f
dfx325.f
dfx326.f
dfx327.f
dfx328.f
dfx329.f
dfx331.f
dfx332.f
dfx333.f
dfx334.f
dfx335.f
dfx336.f
dfx337.f
dfx338.f
dfx339.f
dfx340.f
dfx3aa.f
dfx400.f
dfx401.f
dfx402.f
dfx403.f
dfx404.f
dfx500.f
dfx501.f
dfx502.f
dfx503.f
dfx5aa.f
dfxd01.f
dfxd02.f
dfxd03.f
dfxd04.f
dfxd05.f
dfxg00.f
dfxg01.f
dfxg02.f
dfxg03.f
dfxg04.f
dfxg05.f
dfxg50.f
dfxg54.f
dfxg55.f
dfxm00.f
dfxm01.f
dfxm04.f
dfxm11.f
dfxm31.f
dfxm32.f
dfxms0.f
dfxms7.f
dfxmsa.f
dfxut1.f
dgterm.f
dimend.f
dimset.f
divuni.f
dot.f
drawxa.f
drawya.f
dshdot.f
dshoff.f
dsvgcol.f
dtek4k.f
dtheta.f
edges.f
elarc1.f
elarc2.f
ellips.f
enblnk.f
enpane.f
ensymc.f
entxtc.f
escoff.f
escon.f
fnplot.f
frame.f
getbyt.f
grad.f
gragrp.f
graph.f
graphe.f
graphf.f
grcon.f
grcona.f
grdef.f
grfram.f
groff.f
gron.f
grtoac.f
hatch.f
histgr.f
hls.f
hls1.f
hls2.f
hls3.f
hper.f
hrep.f
hsv.f
hsv1.f
hsv2.f
hsv3.f
hvyint.f
hvytyp.f
hwspot.f
ibcnt.f
init00.f
inqb.f
inqc.f
inqf.f
inqi.f
inqr.f
interp.f
intrnd.f
intrpt.f
intsf.f
intsf1.f
intsf2.f
intsf3.f
intsy.f
intsy1.f
intsy2.f
intsy3.f
intvar.f
inum.f
irndup.f
italic.f
ixax.f
iyax.f
join.f
ldabet.f
ldlut0.f
ldmark.f
ldsym.f
link.f
linr.f
linsf.f
linsf1.f
linsf2.f
linsf3.f
linx.f
linxy.f
liny.f
loglim.f
logr.f
logtik.f
logx.f
logxy.f
logy.f
lower.f
lryopt.f
lrytik.f
lryval.f
ltitle.f
luxopt.f
luxtik.f
luxval.f
lxalab.f
lxatik.f
lxaval.f
lxlab.f
lxopt.f
lxtik.f
lxval.f
lyalab.f
lyatik.f
lyaval.f
lylab.f
lyopt.f
lytik.f
lyval.f
margin.f
marker.f
markht.f
mono.f
monsx.f
monsy.f
monthx.f
monthy.f
neworg.f
noaxt.f
nochck.f
nocint.f
noclab.f
noital.f
noivar.f
nomap.f
norot.f
nospos.f
nounln.f
nrmtyp.f
oblank.f
off2.f
oldorg.f
on2.f
opane.f
outlin.f
owcwin.f
owndsh.f
ows.f
owsvp.f
owswin.f
pane.f
paral1.f
paral2.f
piecht.f
point.f
polar.f
poldef.f
polfn.f
polfr.f
polgrd.f
poloff.f
polon.f
polout.f
polpts.f
polpy3.f
polpy5.f
poltoa.f
poly3.f
poly3e.f
poly5.f
poly5e.f
polygn.f
posn.f
prop.f
ptplot.f
ptplte.f
radgrp.f
radian.f
radsep.f
rdiv.f
rect.f
relax.f
relfr.f
rescmp.f
restxt.f
rgb.f
rgb1.f
rgb2.f
rgb3.f
rnum.f
rotate.f
rrange.f
rtik.f
rval.f
rxax.f
rxtik.f
rxval.f
ryalab.f
ryatik.f
ryaval.f
ryax.f
rylab.f
ryopt.f
rytik.f
ryval.f
samer.f
samert.f
samet.f
samex.f
samexy.f
samey.f
setcex.f
setcsp.f
setdsh.f
setfr.f
setitl.f
setlut.f
setovr.f
setspf.f
setsub.f
setsup.f
setun.f
shdegr.f
sinum.f
sldsym.f
spots1.f
spots2.f
spots3.f
spotsf.f
srnum.f
stepgr.f
strail.f
strfit.f
strful.f
string.f
supabs.f
suprel.f
swspot.f
symang.f
symcon.f
symht.f
sympos.f
symtxt.f
tikcon.f
tlevs.f
tmporg.f
trange.f
ttik.f
tval.f
txtcon.f
txtlen.f
txtpos.f
unlin.f
upper.f
useref.f
usetpe.f
utitle.f
uxalab.f
uxatik.f
uxaval.f
uxlab.f
uxopt.f
uxtik.f
uxval.f
vismk.f
wstpe.f
xaxis.f
xgrid.f
xunit.f
xygrid.f
yaxis.f
ygrid.f
yiq.f
yiq1.f
yiq2.f
yiq3.f
ytv.f
ytv1.f
ytv2.f
ytv3.f
yuv.f
yuv1.f
yuv2.f
yuv3.f
)
#
#echo ${F_LIST[@]}
#
C_LIST=(
dfxc00.cmn
dfxc00s.cmn
dfxc01.cmn
dfxc01s.cmn
dfxc02.cmn
dfxc02s.cmn
dfxc03.cmn
dfxc04.cmn
dfxc05.cmn
dfxc06.cmn
dfxc07.cmn
dfxc09.cmn
dfxc10.cmn
dfxc10s.cmn
dfxc11.cmn
dfxc12.cmn
dfxc13.cmn
dfxc13s.cmn
dfxc14.cmn
dfxc15.cmn
dfxc16.cmn
dfxc17.cmn
dfxc20.cmn
dfxc20s.cmn
dfxc21.cmn
dfxc22.cmn
dfxc22b.cmn
dfxc23.cmn
dfxc24.cmn
dfxcaa.cmn
dfxcab.cmn
dfxcac.cmn
dfxcacs.cmn
dfxcad.cmn
dfxcae.cmn
dfxcba.cmn
dfxcbb.cmn
dfxcbc.cmn
dfxcbcs.cmn
dfxcbd.cmn
dfxcbe.cmn
dfxcbf.cmn
dfxcd0.cmn
dfxcd0s.cmn
dfxcp0.cmn
dfxk05.cmn
params.cmn
)
#
# Get the source files, pre-processing them along the way.
for i in "${!F_LIST[@]}"; do
    get_file "${F_LIST[$i]}"
done
#
for i in "${!C_LIST[@]}"; do
    get_file "${C_LIST[$i]}"
done
#
# Cross-compile with kFTC.
cd dimfm-source
#
for i in "${!F_LIST[@]}"; do
    compile "${F_LIST[$i]}"
done
#
echo "... creating static library dimfilm.lib."
#
# Process the source file list to an object file list.
O_LIST=()
for i in "${!F_LIST[@]}"; do
    F_NAME="${F_LIST[$i]}"
    O_NAME="${F_NAME%.f}.o"
    O_LIST+=("${O_NAME}")
done
echo "${O_LIST[@]}"
#
# Create the library.
lib -l dimliblist.lst -o ../lib/dimfilm.lib "${O_LIST[@]}"
#
cd ..
#
echo "... done."
